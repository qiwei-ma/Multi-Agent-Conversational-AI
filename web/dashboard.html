<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="ScreenOrientation" content="autoRotate:disabled">
    <title>Multi-agent spoken bot</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- 优先使用 BootCDN -->
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- 回退到本地文件 -->
    <!-- <link id="bootstrap-fallback" href="/static/bootstrap-5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" disabled> -->
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="dashboard.css">

    <script src="client.js"></script>
    <!-- <script src="srs.sdk.js"></script> -->
    <script src="static/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="dashboard.js"></script>

    <style>
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom right, #333333, #000000);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            opacity: 1;
            cursor: pointer;
        }

        .play-icon {
            font-size: 64px;
            margin-bottom: 16px;
            transition: transform 0.3s;
        }

        .play-text {
            font-size: 20px;
            opacity: 0.9;
        }

        #start-overlay:hover .play-icon {
            transform: scale(1.1);
        }
    </style>

</head>

<body>
    <!-- HTML 结构中提前插入遮罩层，防止内容先闪现 -->
    <div id="start-overlay">
        <div class="play-icon">▶</div>
        <div class="play-text">点击开始</div>
    </div>

    <div class="dashboard-container">

        <div class="row">
            <!-- 视频区域 -->
            <video id="video" autoplay playsinline></video>

            <!-- 加载进度条 -->
            <div id="loading-container" class="loading-overlay">
                <div class="loading-content">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="progress mt-3">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                            role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="loading-text mt-2">正在加载人物模型...</p>
                </div>
            </div>

            <!-- 右侧交互 -->
            <div id="chat-panel" class="hidden">
                <!-- 控制按钮：切换右侧交互显示与隐藏 -->


                <div class="card h-100">
                    <button id="toggle-chat" class="toggle-chat-btn">
                        <i class="bi bi-chevron-double-right"></i>
                    </button>

                    <div class="card-body">
                        <div class="tab-content" id="interaction-tabs-content">
                            <!-- 对话模式 -->
                            <div class="tab-pane fade show active" id="chat" role="tabpanel" aria-labelledby="chat-tab">
                                <div class="asr-container mb-3" id="chat-messages">


                                </div>


                                <form id="chat-form">
                                    <div class="input-group mb-3">
                                        <textarea class="form-control" id="chat-message" rows="2"></textarea>
                                        <button class="btn btn-primary" type="submit">
                                            <i class="bi bi-send-fill" style="color: var(--primary-color);"></i>
                                        </button>
                                    </div>
                                </form>
                                <div class="chat-controls">
                                    <button id="clearHistoryBtn" class="clearHistoryBtn">清空记录</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="row">
            <div class="col-12">
                <!-- 按住说话按钮 -->
                <div class="voice-record-btn" id="voice-record-btn">
                    <i class="bi bi-mic-fill"></i>
                </div>
                <div class="voice-record-label">按住此处或空格说话</div>
                <!-- 添加倒计时显示 -->
                <div class="countdown-timer" id="countdown-timer">59</div>
            </div>
        </div>


    </div>

    <!-- 隐藏的会话ID -->
    <input type="hidden" id="sessionid" value="0">


</body>

<script>
    // 检查页面来源
    (function checkReferer() {
    // 获取来源页面
        const referrer = document.referrer;
        // 如果不是从login.html来或者直接打开，则跳转到登录页
        if (!referrer.includes('login.html')) {
            window.location.href = 'login.html';
            return;
        }
    })();

    const toggleBtn = document.getElementById('toggle-chat');
    const chatPanel = document.getElementById('chat-panel');

    let isHidden = false;
    let isMobile = false;

    // 添加设备检测函数
    function isMobileDevice() {
        return window.innerWidth <= 666;
    }

    isMobile = isMobileDevice();

    // 监听窗口大小变化
    window.addEventListener('resize', () => {
        const wasMobile = isMobile;
        isMobile = isMobileDevice();
        
        // 只有在设备类型发生变化时才更新样式
        if (wasMobile !== isMobile) {
            // 根据当前状态更新面板位置
            if (isMobile) {
                chatPanel.style.transform = isHidden ? 
                    'translateX(-1%) translateY(99%)' : 
                    'translateX(0) translateY(0)';
            } else {
                chatPanel.style.transform = isHidden ? 
                    'translateX(103%) translateY(-50%)' : 
                    'translateX(0) translateY(-50%)';
            }
        }
    });

    toggleBtn.addEventListener('click', () => {
        isHidden = !isHidden;
        if(isMobile) {
            chatPanel.style.transform = isHidden ? 
            'translateX(-1%) translateY(99%)' : 
            'translateX(0) translateY(0)';
        } else {
            chatPanel.style.transform = isHidden ? 
            'translateX(103%) translateY(-50%)' : 
            'translateX(0) translateY(-50%)';
        }
        toggleBtn.innerHTML = isHidden ? 
            '<i class="bi bi-chevron-double-left"></i>' : 
            '<i class="bi bi-chevron-double-right"></i>';
    });

    function updateConnectionStatus(status) {
        const statusIndicator = $('#connection-status');
        const statusText = $('#status-text');
        const chatPanel = $('#chat-panel');

        statusIndicator.removeClass('status-connected status-disconnected status-connecting');

        switch (status) {
            case 'connected':
                statusIndicator.addClass('status-connected');
                statusText.text('已连接');
                chatPanel.removeClass('hidden');
                break;
            case 'connecting':
                statusIndicator.addClass('status-connecting');
                statusText.text('连接中...');
                break;
            case 'disconnected':
            default:
                statusIndicator.addClass('status-disconnected');
                statusText.text('未连接');
                break;
        }
    }

    // 开始/停止按钮
    function startclick() {
        updateConnectionStatus('connecting');
        start();
        $(this).hide();
        // $('#stop').show();

        // 显示加载进度条
        $('#loading-container').show();

        // 重置进度条
        $('#progress-bar').css('width', '0%');
        $('.loading-text').html('正在加载人物...<br>首次加载预计耗时60秒...');

        // 添加定时器更新进度条
        let progress = 0;
        let progressInterval = setInterval(function () {
            progress += 5; // 每次增加5%
            $('#progress-bar').css('width', progress + '%');

            // 如果进度超过85%但还没连接成功，保持进度
            if (progress >= 85) {
                clearInterval(progressInterval);
            }
        }, 300);

        // 添加定时器检查视频流是否已加载
        let connectionCheckTimer = setInterval(function () {
            const video = document.getElementById('video');
            // 检查视频是否有数据
            if (video.readyState >= 3 && video.videoWidth > 0) {
                updateConnectionStatus('connected');
                clearInterval(connectionCheckTimer);
                clearInterval(progressInterval);

                // 快速完成进度条
                $('#progress-bar').css('width', '100%');
                $('.loading-text').text('连接成功！');

                // 1秒后隐藏加载进度条
                setTimeout(function () {
                    $('#loading-container').hide();
                });
            }
        }, 500);


        // 60秒后如果还是连接中状态，就停止检查
        setTimeout(function () {
            if (connectionCheckTimer) {
                clearInterval(connectionCheckTimer);
                clearInterval(progressInterval);
                $('.loading-text').text('连接超时，请重试');
                $('#progress-bar').css('width', '100%').removeClass('progress-bar-animated')
                    .addClass('bg-danger');

                // 3秒后自动隐藏
                setTimeout(function () {
                    $('#loading-container').fadeOut();
                }, 3000);
            }
        }, 60000);
    };

    function stopclick() {
        stop();
        $(this).hide();
        updateConnectionStatus('disconnected');
    };

    // 鼠标靠近右边自动展开
    // document.addEventListener('mousemove', (e) => {
    //     if (isHidden && e.clientX > window.innerWidth - 40) {
    //         if(isMobileDevice()) {
    //             chatPanel.style.transform = 'translateX(-1%) translateY(100%)';
    //         } else {
    //             chatPanel.style.transform = 'translateX(103%) translateY(-50%)';
    //         }
    //         isHidden = false;
    //         toggleBtn.innerHTML = isHidden ? 
    //         '<i class="bi bi-chevron-double-left"></i>' : 
    //         '<i class="bi bi-chevron-double-right"></i>';
    //     }
    // });

    // let touchStartY = 0;
    // let touchEndY = 0;

    // // 触摸开始时记录位置
    // document.addEventListener('touchstart', (e) => {
    //     touchStartY = e.touches[0].clientY;
    // });

    // // 触摸结束时判断方向和位置
    // document.addEventListener('touchend', (e) => {
    //     touchEndY = e.changedTouches[0].clientY;
    //     const touchX = e.changedTouches[0].clientX;
        
    //     // 计算滑动距离
    //     const slideDistance = touchStartY - touchEndY;
        
    //     // 如果是向上滑动且在屏幕下方区域（最后20%的区域）
    //     if (slideDistance > 50 && touchStartY > window.innerHeight * 0.8) {
    //         if (isHidden) {
    //             if(isMobileDevice()) {
    //                 chatPanel.style.transform = 'translateX(-1%) translateY(100%)';
    //             } else {
    //                 chatPanel.style.transform = 'translateX(103%) translateY(-50%)';
    //             }
    //             isHidden = false;
    //             toggleBtn.innerHTML = '<i class="bi bi-chevron-double-right"></i>';
    //         }
    //     }
    // });

    document.addEventListener('DOMContentLoaded', function () {
        const overlay = document.getElementById('start-overlay');

        function enterFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        overlay.addEventListener('click', function () {
            enterFullscreen();
            if (typeof startclick === 'function') {
                startclick();
            }
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.remove();
            }, 300);
        }, { once: true });
    });

    // 页面关闭或刷新时自动点击“停止”按钮
    window.addEventListener('beforeunload', function () {
        stopclick();
    });
</script>

</html>
